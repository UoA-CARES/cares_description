<?xml version="1.0"?>
<robot name="stereo_pair" xmlns:xacro="http://wiki.ros.org/xacro">
  <xacro:macro name="stereo_pair" params="parent *origin prefix calibration_file name:=stereo_pair">
    <xacro:property name="M_PI"     value="3.1415926535897931" />
      
    <!-- Base Link Setup -->
    <xacro:joint_xacro name="${prefix}ee_coupler" parent="${parent}" child="${prefix}${name}_base_link" type="fixed"/>

    <!-- Add the stereo stl -->
    <xacro:link_xacro name="${prefix}${name}_base_link" filename="package://cares_description/meshes/visual/stereo_mount.stl" rpy="${pi/2} -${pi} ${pi/2}" scale="0.001 0.001 0.001"/> 

    <!-- Box to protect the cables - maybe move to the stl -->
    <xacro:joint_xacro name="${prefix}cables_coupler" parent="${prefix}${name}_base_link" child="${prefix}cables" type="fixed"/>      
    <link name="${prefix}cables">
      <xacro:cube xyz="-0.018 0.0 -0.06" size="0.035 0.14 0.03"/>
    </link>

    <!-- Load calibration files for the specific stereo pair to set left frame -->
    <xacro:property name="handeye_calibration_file" value="${calibration_file}" />
    <xacro:property name="handeye_calibration"      value="${load_yaml(handeye_calibration_file)}"/>

    <!-- Body Frame for the stereo pair calibrated centre -->
    <link name="${prefix}${name}_left_frame" />

    <joint name="${prefix}${name}_left_joint" type="fixed">
      <origin xyz="${handeye_calibration['transformation']['x']} ${handeye_calibration['transformation']['y']} ${handeye_calibration['transformation']['z']}" rpy="${handeye_calibration['transformation']['roll']} ${handeye_calibration['transformation']['pitch']} ${handeye_calibration['transformation']['yaw']}"/>
      <parent link="${prefix}${name}_base_link" />
      <child link="${prefix}${name}_left_frame" />
    </joint>    

    <!-- Optical Frame for the stereo pair calibrate centre -->    
    <link name="${prefix}${name}_left_optical_frame" />
    <xacro:joint_xacro name="${prefix}${name}_left_optical_joint" parent="${prefix}${name}_left_frame" child="${prefix}${name}_left_optical_frame" rpy="${-M_PI/2} 0 ${-M_PI/2}" type="fixed"/>

  </xacro:macro>
</robot>
